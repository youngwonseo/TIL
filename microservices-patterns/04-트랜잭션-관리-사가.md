# 트랙잭션 관리: 사가

## 데이터 일관성 유지: 사가 패턴

* 사가는 마이크로서비스 아키텍처에서 분산 트랙잭션 없이 데이터 일관성을 유지하는 매커니즘을 의미
  * 비동기 메시지를 이용하여 편성한 일련의 로컬 트랜잭션, 서비스 간 데이터 일관성을 유지
* 여러 서비스의 데이터를 업데이트하는 시스템 커맨드마다 사가를 하나씩 정의
* 사가는 일련의 로컬 트랜잭션
  * 각 로컬 트랜잭션은 ACID 트랜잭션 프레임워크/라이브러리를 이용해서 서비스별 데이터를 업데이트

* 사가와 ACID 트랜잭션의 두 가지 중요한 차이점
  1. ACID 트랜잭션에 있는 격리성이 사가에는 없음
  2. 사가는 로컬 트랜잭션마다 변경분을 커밋하므로 보상 트랜잭션을 걸어 롤백을 수행해야함

### 예제: 주문 생성 사가

* 주문 생성 사가는 6개의 로컬 트랜잭션으로 구성
  1. 주문 서비스: 주문을 APPROVAL_PENDING 상태로 생성
  2. 소비자 서비스: 주문 가능한 소비자인지 확이
  3. 주방 서비스: 주문 내역을 확인, 티켓을 CREATE_PENDING 상태로 생성
  4. 회계 서비스: 소비자 신용카드를 승인
  5. 주방 서비스: 티켓 상태를 AWAITING_ACCEPTANCE로 변경
  6. 주문 서비스: 주문 상태를 APPROVED로 변경

* 각 서비스는 로컬 트랜잭션이 완료되면 메시지를 발행하여 다음 사가 단계를 트리거
* 메시지를 통해 사가 참여자를 느슨하게 결합하고 반드시 완료되도록 보장하는 것


## 사가 편성

* 사가는 단계를 편성하는 로직트로 구성
* 다름은 사가 편성 로직의 두 가지 동류
  1. 코레오그래피(choreography)
  2. 오케스트레이션(orchestration)

### 코레오그래피 사가

* 사가 참여자가 할 일을 알려 주는 중앙 편성자가 없는 방식
* 사가 참여자가 서로 이벤트를 구독해서 그에 따라 반응
* 코레오크래피 방식으로 사가 구현 시 두 가지 통신 이슈를 고려해야함
  1. 사가 참여자가 자신의 DB를 업데이트하고, DB 트랜잭션의 일부로 이벤트를 발행하도록 해야함
  2. 사가 참여자는 자신이 수신한 이벤트와 자신이 가진 데이터를 연관 지을 수 있어야함

#### 코레오그래피 사가의 장단점

* 장점
  * 단순함
  * 느슨한 결합
* 잔점
  * 이애하기 어려움
  * 서비스 간 순환 의존성
  * 단단히 결합될 위험성

### 오케스트레이션

* 사가 편성 로직을 사가 오케스트레이터에 중앙화
* 사가 참여자가 할일을 알려주는 오케스트레이터 클래스를 정의
* 사가 오케스트레이터는 사가 참여자와 커맨드/비동기 응답 상호작용

#### 오케스트레이션 사가의 장단점

* 장점
  * 의존 관계 단순화
  * 낮은 결합도
  * 관심사를 더 분리하고 비즈니스 로직을 단순화
* 단점
  * 오케스트레이터 하나가 깡통 서비스에 일일이 할일을 지시하는 아키텍처로 변할 수 있음

## 비격리 문제 처리

## 주문 서비스 및 주문 생성 사가 설계

## References

* [마이크로서비스 패턴 - 크리스 리처슨 지음,이일웅 옮김(길벗)](https://www.gilbut.co.kr/book/view?bookcode=BN002687)
