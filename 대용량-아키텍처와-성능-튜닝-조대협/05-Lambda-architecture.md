# Lambda Architecture


람다 아키텍처란 트위터에서 스트리밍 컴퓨터를 담당했던 네이선 마츠(Nathan Marz)에 의해 소개된 실시간 분석을 지원하는 빅데이터 아키텍처이다. 자세한 설명은 http://lambda-architecture.net/ 에 소개되어 있다.

## 1. 람다 아키텍처를 설명을 위한 하나의 시나리오
### 1.1 문제의 정의

다음과 같은 서비스를 운영하고 있다고 가정하자.
  * SNS서비스이다.
  * 글쓰기, 읽기, 쓰기 등의 약 1,000개의 이벤트가 존재한다.
  * 사용자가 대략 1억명이다.

위와 같은 조건에서 모든 사용자의 일일 이벤트 사용량 로그를 다음과 같이 RDBMS를 사용하여 관리한다고 가정하자.

  | 날짜         | 사용자  | 읽기   | 쓰기   |
  | ---------- | ---- | ---- | ---- |
  | 2017.12.10 | 서영원  | 3    | 2    |
  | ...        | ...  | ...  | ...  |

* 이러한 환경에서 **특정 기간에 대한, 가장 많이 활용되는 이벤트 TOP5를 실시간**으로 확인하고 싶으면 어떻게 해야될까? 가장 쉬운 접근법은 SQL을 실행하여 확인하는 것이지만, 문제는 간단하지 않다. 
* 이유는 1억명의 사용자와 1000개의 이벤트이다. 즉 매일 1000개의 컬럼을 갖는 1억개의 레코드가 생성된다. 
* 한달이면 30억개의 레코드가 생성되는 환경에서 일반적인 동적SQL은 실행시간을 보장 받기 힘들다. 아니 불가능하다!

### 1.2 배치 활용

* 위와 같은 문제를 해결하는 전통정인 방법은 배치(Batch)처리이다. 예로 들면 밤12시마다 전날의 이벤트 통계를 계산해놓는것이다(여기서는 일별 이벤트 사용수에 대한 합을 계산해놓는것이다).
* 하루에 한개의 통계결과를 생성하기 때문에 일년에 365의 행만 존재 할 뿐이다.
* 이런 시스템의 경우 어제까지의 데이터집계만 반영, 즉 실시간 데이터가 아니라는 문제가 존재한다. 하지만 어제까지의 집계와 오늘 발생한 로그테이블의 조인을 통해 실시간 데이터를 보장할 수 있다.

### 1.3 실시간 집계 테이블 활용

* 마지막에 언급된 조인과 배치가 해답일까? 아니다. 처음 언급한 것과 같이 1000개의 컬럼에 1억개라는 레코드가 하루에 발생한다. 그렇다면 1억개의 레코드를 조인해야하는데 적절한 성능을 기대하기 어렵다.
* 그렇다면 일별 배치를 돌리고, 일별 통계테이블을 따로 관리하면 어떨까? 배치결과와 오늘날짜의 통계 레코드 한개의 조인을 통해 실시간 데이터를 제공한다는 것이다. 이러한 경우 실시간으로 통계정보를 제공가능하다. 
* 책에는 언급이 안되어있지만 이런식으로 일별 통계를 실시간으로 터리하면 배치가 할 작업을 미리 하는것이 아닌가 하는 생각을 해본다.

## 2. 람다 아키텍처 활용

다음은 람다 아키텍처의 데이터 흐름에 대한 그림이다. 이전 시나리오의 문제 해결방안과 같이 **배치처리**와 **실시간 처리**가 존재한다.

  ![](http://lambda-architecture.net/img/la-overview_small.png)

크게 두가지의 흐름이 존재한다. 첫 번째는 배치처리에 대한 흐름이다.
  * 배치처리를 위해 모든 데이터를 데이터 저장소에 저장된다. 
  * 데이터 저장소에 저장된 데이터는 일정한 시간을 주기로 배치처리한 후 배치뷰를 생성한다.

두 번째는 실시간처리에 대한 흐름이다.
  * 실시간 처리를 해서 실시간 뷰를 생성한다.
  * 마지막은 두개의 흐름에서 발행한 뷰를 합쳐 실제 실시간의 통계나 적절한 결과를 만들어 출력한다.

뷰는 다음과 같은 특징을 가진다.
  * 배치뷰에 대한 데이터는 읽기만 가능하다.
  * 실시간 뷰는 실시간으로 읽기 쓰기가 가능하다.


다음은 책에서 소개된 각 레이어별 솔루션이다. 저자 조대협님과 Dr. Dobb's에 소개된 솔루션들의 조합니다.

  | 단계                | 솔루션                                      |
  | ----------------- | ---------------------------------------- |
  | 저장소<br />배치 처리    | HDFS, Amazon S3<br />Map & Reduce        |
  | 배치 뷰              | HBase, Elephant DB, Apache Drill, Amazon RedShift, HP Vertica |
  | 실시간 처리<br />실시간 뷰 | Storm, Spark<br />Redis, RDBMS           |

  * 3단계를 각각 배치계층, 서빙(Serving)계층, 스피드 계층이라 한다. 


## 3. 람다 아키텍처의 재구성
### 3.1 RDBMS를 활용

* 각 레이어는 하둡이나 NoSQL등의 솔루션이 각각 사용되기 때문에 서로 다른 솔루션에 포함되어 있는 데이터를 조합하여 사용할 수 없다(예로 들면 배치뷰에 HBase, 실시간 뷰에 Redis).
* 이 경우 각 단계에 RDBMS 사용하여 정렬 및 그룸핑등의 작업을 수행할 수 있다.
  * 책에는 HP Vertica의 경우 SQL을 지원면서, 행단위가 아닌 열단위 처리방식을 가지고 있아 통계에 대한 성능이 매우 뛰어나다고 소개되고 있다.

### 3.2 데이터 분석 도구를 이용한 새로운 분석 모델 개발

* 데이터 사이언티스트의 영역으로 R이나 Matlab등의 도구를 이용하여 상관관계 및 새로운 통계 모델을 설계하고 검증하는 것을 말한다.
* 검증이 완료된 알고리즘은 빅데이터 엔지니어에게 전달되 시스템에 알맞게 적용된다.

## 4. 람다 아키텍터를 활용한 트위터 트윗 분석 케이스
하나의 케이스를 살펴보자.
  * http://lambda-architecture.net/stories/2017-04-15-Twitter-tweets-analysis
  * https://blog.knoldus.com/2017/01/31/twitters-tweets-analysis-using-lambda-architecture/

  ![](https://knoldernarayan.files.wordpress.com/2017/01/lambda-architecture-2-800.jpg?w=640)

  ​

## References
* 대용량 아키텍처와 성능 튜닝 - 조대협 | 프리렉 (<http://www.yes24.com/24/goods/17018954>)
* http://lambda-architecture.net