# gRPC 동작 원리

* gRPC 어플리케이션 개발자는 RPC 구현방법, 사용되는 메시지 인코딩 기술, RPC가 네크워크에서 작동하는 방식등의 세부 처리를 알 필요는 없음
* 모든 저수준 통신 처리는 생성된 코드로 구현됨
* 그러나 복잡한 gRPC 기반 시스템 구축과 실서비스 운영을 위해서는 동작원리를 알 필요가 있음

이 장에서는 다음을 배웁니다.

* gRPC 통신 흐름이 구현되는 방법
* 사용되는 인코딩 기술
* gRPC가 네트워크 통신 기술을 사용하는 방법
* HTTP/2 기반 gRPC 통신 프로토콜

## RPC 흐름

* 서버는 원격으로 호출되는 일련의 기능을 구현
* 클라이언트는 서버의 기능을 추상화한 **스텁**을 활용하여 서버 기능을 원격 호출

클라이언트가 서버의 기능을 호출하는 단계를 설명하면 다음과 같습니다.

1. 클라이언트는 생성된 스텁에 존재하는 함수를 호출
  * 인코딩 메시지로 HTTP POST요청
  * Content-type이 application/grpc
  * 호출할 원격 함수 정보가 해더에 포함
2. 서버는 수신된 메시지를 서비스 스텁에 넘김
  * 서비스 스텁은 수신된 메시지를 파싱
3. 함수 호출
4. 응답이 인코딩되고 클라이언트로 전송
  * 응답 메시지는 클라이언트에서 같은 과정으로 해석됨

* 위와 같은 gRPC의 원격 호출 절차는 대부분의 RPC 시스템과 유사
* 주요 차이점은 메시지를 인코딩하는 방식
  * gRPC는 인코딩을 위해 **프로토콜 버퍼**를 사용
* 프로토콜 버퍼는 구조화된 데이터를 직렬화하기 위한 언어에 구애 받지 않고 플랫폼 중립적이며 확장 가능한 메커니즘을 가짐

## 프로토콜 버퍼를 사용한 메시지 인코딩

* gRPC는 프로토콜 버퍼를 사용해 서비스 정의를 작성
  * 원격 메서드 정의
  * 보내려는 메시지 정의
  * ![]
* 메시지에는 필드가 포함 됨
  * 필드의 이름
  * 필드의 자료형
  * 필드의 인덱스
* 메시지 정의하는 방법에 따라 인코딩 방식이 결정됨
* 필드 식별자를 태그라고도 함

![] 메시지와 태그

* 태그는 두 가지 값으로 구성
  * 필드 인덱스
  * 와이어 타입
* 필드 인덱스는 메시지 정의때 필드에 할당된 고유 번호
* 와이어 타입은 필드타입을 기반으로 값의 길이를 찾기 위한 정보를 제공

| 와이어 타입 | 종류 | 필드타입 |
|---|:---:|---:|
| 0 | 가변 길이 정수(Varint) | int32, int64, uint32, uint64, sint32, sint64, bool, enum |
| 1 | 64비트 | fixed64, sfixed64, double |
| 2 | 길이 구분(Length-delimited) | string, bytes, embedded messages, packed repeated fields |
| 3 | 시작 그룹(Start group) | groups(사용중단) |
| 4 | 종료 그룹(End group) | groups(사용중단)  |
| 5 | 32비트 | fixed32, sfixed32, float |

### 안코딩 기술

* 가변 길이 정수
* 부호있는 정수
* 비가변 길이 정수 숫자
* 문자열 타입

## 길이-접두사 지정 메시지 프레이밍

## HTTP/2를 통한 gRPC

* HTTP/2는 HTTP/1.1의 보안, 속도 등을 개선하고자 한 HTTP의 두 번째 메이저 버전
  * HTTP/2에서 클라이언트 서버간 모든 통신은 단일 TCP 연결을 통해 처리
  * 스트림
  * 프레임
  * 메시지
* 클라이언트가 gRPC 채널을 만들면 내부적으로 서버와의 HTTP/2 연결을 생성
  * 채널이 생성되면 여러개의 원격 호출을 보낼수 있도록 재사용 됨
  * 원격 호출은 HTTP/2 스트림으로 처리
  * 전송된 메시지는 HTTP/2 프레임으로 전송
  * gRPC 길이-접두사 지정 메시지를 보내거나 데이터가 큰경우 여러 데이터 프레임에 걸쳐 전송

### 요청 메시지

* 요청 해더, 길이접두사 메시지, 스트림 종료 플래그로 구성

### 응답 메시지

* 응답 해더, 길이-접두사 지정 메시지, 트레일러로 구성

## gRPC 구현 아키텍처

* gRPC 구현은 여러 레이어로 구성
* 기본 레이어는 core layer
  * 상위 레이어의 모든 네트워크 작업을 추상화, 개발자가 네트워크를 통해 RPC호출을 쉽게 수행할 수 있도록 함
  * 핵심 기능의 확장을 제공, 통신 보안용 인증 필터, 타임아웃에 대한 데드라인 필터 등이 여기에 해당
* gRPC는 C/C++, GO, Java를 기본적으로 지원
* 이 외 파이썬, 루비, PHP등에 대한 바인딩을 제공, 이런 바인딩은 하위수준의 C API에 대한 wrapper


![]()

## References

* [gRPC 시작에서 운영까지](http://www.kyobobook.co.kr/product/detailViewKor.laf?ejkGb=KOR&mallGb=KOR&barcode=9791161754635&orderClick=LAG&Kc=)